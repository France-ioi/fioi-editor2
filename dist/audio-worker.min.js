function init(e){sampleRate=e.sampleRate}function record(e){chunksL.push(e[0]),chunksR.push(e[1])}function clearRecordings(){for(var e in recordings){var n=recordings[e];"wav"in n&&URL.revokeObjectURL(n.wav)}recordings={}}function finishRecording(){var e=combineChunks(chunksL);chunksL=[];var n=combineChunks(chunksR);chunksR=[];var r=interleaveSamples(e,n),t=buildStereoWavBlob(r),a=URL.createObjectURL(t);return recordings[a]={wav:t,samples:r},a}function combineRecordings(e){for(var n=[],r=0;r<e.length;r+=1){var t=e[r];if(console.log("fragment",t),t in recordings){var a=recordings[t];console.log("found",a.samples.length,"samples"),n.push(a.samples)}else console.log("not found")}var s=combineChunks(n),i=buildStereoWavBlob(s),t=URL.createObjectURL(i);return recordings[t]={wav:i},t}function interleaveSamples(e,n){if(e.length!=n.length)throw"cannot interleave samples of different length";for(var r=e.length,t=new Float32Array(2*r),a=0,s=0;r>s;)t[a++]=e[s],t[a++]=n[s],s++;return t}function combineChunks(e){for(var n=0,r=0;r<e.length;r++)n+=e[r].length;var t=new Float32Array(n),a=0;for(r=0;r<e.length;r++)t.set(e[r],a),a+=e[r].length;return t}function sendMessage(e,n){this.postMessage({callbackId:e.data.callbackId,result:n})}function floatTo16BitPCM(e,n,r){for(var t=0;t<r.length;t++,n+=2){var a=Math.max(-1,Math.min(1,r[t]));e.setInt16(n,0>a?32768*a:32767*a,!0)}}function writeString(e,n,r){for(var t=0;t<r.length;t++)e.setUint8(n+t,r.charCodeAt(t))}function buildStereoWavBlob(e){var n=new ArrayBuffer(44+2*e.length),r=new DataView(n);return writeString(r,0,"RIFF"),r.setUint32(4,32+2*e.length,!0),writeString(r,8,"WAVE"),writeString(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,2,!0),r.setUint32(24,sampleRate,!0),r.setUint32(28,4*sampleRate,!0),r.setUint16(32,4,!0),r.setUint16(34,16,!0),writeString(r,36,"data"),r.setUint32(40,2*e.length,!0),floatTo16BitPCM(r,44,e),new Blob([n],{type:"audio/wav"})}var chunksL=[],chunksR=[],sampleRate,recordings={};this.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"finishRecording":var n=finishRecording();sendMessage(e,{url:n});break;case"combineRecordings":var n=combineRecordings(e.data.recordings);sendMessage(e,{url:n});break;case"getRecording":var r=recordings[e.data.recording];sendMessage(e,r&&r.wav);break;case"clearRecordings":clearRecordings(),sendMessage(e,{})}};