function init(e){recordingSampleRate=e.sampleRate}function record(e){chunksL.push(e[0]),chunksR.push(e[1])}function clearRecordings(){for(var e in recordings){var n=recordings[e];"wav"in n&&URL.revokeObjectURL(n.wav)}recordings={}}function finishRecording(){var e={numChannels:1,sampleSize:1,sampleRate:recordingSampleRate},n=combineChunks(chunksL);chunksL=[];var t=combineChunks(chunksR);chunksR=[];var r=2==e.numChannels?interleaveSamples(n,t):averageSamples(n,t);48e3==recordingSampleRate&&(r=downsample3x(r),e.sampleRate=16e3,e.sampleSize=2);var a=encode_wav(r,e),s=URL.createObjectURL(a);return recordings[s]={wav:a,samples:r},s}function combineRecordings(e){for(var n=[],t=0;t<e.length;t+=1){var r=e[t];if(console.log("fragment",r),r in recordings){var a=recordings[r];console.log("found",a.samples.length,"samples"),n.push(a.samples)}else console.log("not found")}var s=combineChunks(n),i=buildStereoWavBlob(s),r=URL.createObjectURL(i);return recordings[r]={wav:i},r}function averageSamples(e,n){if(e.length!=n.length)throw"cannot average samples of different length";for(var t=e.length,r=new Float32Array(t),a=0,s=0;t>s;)r[a++]=(e[s]+n[s])/2,s++;return r}function interleaveSamples(e,n){if(e.length!=n.length)throw"cannot interleave samples of different length";for(var t=e.length,r=new Float32Array(2*t),a=0,s=0;t>s;)r[a++]=e[s],r[a++]=n[s],s++;return r}function combineChunks(e){for(var n=0,t=0;t<e.length;t++)n+=e[t].length;var r=new Float32Array(n),a=0;for(t=0;t<e.length;t++)r.set(e[t],a),a+=e[t].length;return r}function sendMessage(e,n){this.postMessage({callbackId:e.data.callbackId,result:n})}function floatTo16BitPCM(e,n,t){for(var r=0;r<t.length;r++,n+=2){var a=Math.max(-1,Math.min(1,t[r]));e.setInt16(n,0>a?32768*a:32767*a,!0)}}function floatTo8BitPCM(e,n,t){for(var r=0;r<t.length;r++,n+=1){var a=(Math.max(-1,Math.min(1,t[r]))+1)/2;e.setInt8(n,255*a,!0)}}function writeString(e,n,t){for(var r=0;r<t.length;r++)e.setUint8(n+r,t.charCodeAt(r))}function FIR(e){this.coeffs=e,this.nCoeffs=e.length,this.registers=new Float32Array(this.nCoeffs),this.iTopReg=this.nCoeffs-1}function downsample6x(e){return downsample(e,new FIR(FIR_48k_8k),6)}function downsample3x(e){return downsample(e,new FIR(FIR_48k_16k),3)}function downsample(e,n,t){for(var r=FIR_48k_8k.length,a=0,s=0;2*r>s;s++)n.sampleIn(e[a++]);for(var i=0,o=new Float32Array(e.length/t),c=0;a<e.length;)0==c&&(o[i++]=n.sampleOut()),++c==t&&(c=0),n.sampleIn(e[a++]);for(;i<o.length;)o[i++]=n.sampleOut(),n.sampleIn(0);return o}function encode_wav(e,n){var t=n.numChannels*n.sampleSize,r=e.length*t,a=new ArrayBuffer(44+r),s=new DataView(a);switch(writeString(s,0,"RIFF"),s.setUint32(4,a.byteLength-8,!0),writeString(s,8,"WAVE"),writeString(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,n.numChannels,!0),s.setUint32(24,n.sampleRate,!0),s.setUint32(28,n.sampleRate*t,!0),s.setUint16(32,t,!0),s.setUint16(34,8*n.sampleSize,!0),writeString(s,36,"data"),s.setUint32(40,r,!0),n.sampleSize){case 1:floatTo8BitPCM(s,44,e);break;case 2:floatTo16BitPCM(s,44,e)}return new Blob([a],{type:"audio/wav"})}var chunksL=[],chunksR=[],recordingSampleRate,recordings={};this.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"finishRecording":var n=finishRecording();sendMessage(e,{url:n});break;case"combineRecordings":var n=combineRecordings(e.data.recordings);sendMessage(e,{url:n});break;case"getRecording":var t=recordings[e.data.recording];sendMessage(e,t&&t.wav);break;case"clearRecordings":clearRecordings(),sendMessage(e,{})}},FIR.prototype.sampleIn=function(e){var n=this.iTopReg;n+=1,n>=this.nCoeffs&&(n=0),this.registers[n]=e,this.iTopReg=n},FIR.prototype.sampleOut=function(){for(var e=0,n=0,t=this.iTopReg;t>=0;t--)e+=this.coeffs[n++]*this.registers[t];for(var t=this.nCoeffs-1;t>this.iTopReg;t--)e+=this.coeffs[n++]*this.registers[t];return e};var FIR_48k_8k=[.028593547515597933,.03670747252586807,-.003425102001388845,-.05953402135953233,-.060917024563134026,.03697894250548,.19858060022396978,.32301558515313944,.32301558515313944,.19858060022396978,.03697894250548,-.060917024563134026,-.05953402135953233,-.003425102001388845,.03670747252586807,.028593547515597933],FIR_48k_16k=[.025988926951079665,-.013257585857849584,-.01828825082150171,.04308749505022258,-.03213590725580088,-.02054974978239911,.08284966957828693,-.09349946285437129,-.02176391714488415,.5475687821372176,.5475687821372176,-.02176391714488415,-.09349946285437129,.08284966957828693,-.02054974978239911,-.03213590725580088,.04308749505022258,-.01828825082150171,-.013257585857849584,.025988926951079665];