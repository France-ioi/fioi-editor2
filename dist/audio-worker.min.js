function init(e){sampleRate=e.sampleRate}function record(e){chunksL.push(e[0]),chunksR.push(e[1])}function clearRecordings(){for(var e in recordings){var n=recordings[e];"wav"in n&&URL.revokeObjectURL(n.wav)}recordings={}}function finishRecording(){var e=combineChunks(chunksL);chunksL=[];var n=combineChunks(chunksR);chunksR=[];var t=interleaveSamples(e,n),r=buildStereoWavBlob(t),a=URL.createObjectURL(r);return recordings[a]={wav:r,samples:t},a}function combineRecordings(e){for(var n=[],t=0;t<e.length;t+=1){var r=e[t];if(console.log("fragment",r),r in recordings){var a=recordings[r];console.log("found",a.samples.length,"samples"),n.push(a.samples)}else console.log("not found")}var i=combineChunks(n),s=buildStereoWavBlob(i),r=URL.createObjectURL(s);return recordings[r]={wav:s},r}function interleaveSamples(e,n){if(e.length!=n.length)throw"cannot interleave samples of different length";for(var t=e.length,r=new Float32Array(2*t),a=0,i=0;t>i;)r[a++]=e[i],r[a++]=n[i],i++;return r}function combineChunks(e){for(var n=0,t=0;t<e.length;t++)n+=e[t].length;var r=new Float32Array(n),a=0;for(t=0;t<e.length;t++)r.set(e[t],a),a+=e[t].length;return r}function sendMessage(e,n){this.postMessage({callbackId:e.data.callbackId,result:n})}function floatTo16BitPCM(e,n,t){for(var r=0;r<t.length;r++,n+=2){var a=Math.max(-1,Math.min(1,t[r]));e.setInt16(n,0>a?32768*a:32767*a,!0)}}function writeString(e,n,t){for(var r=0;r<t.length;r++)e.setUint8(n+r,t.charCodeAt(r))}function buildStereoWavBlob(e){var n=new ArrayBuffer(44+2*e.length),t=new DataView(n);return writeString(t,0,"RIFF"),t.setUint32(4,32+2*e.length,!0),writeString(t,8,"WAVE"),writeString(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,2,!0),t.setUint32(24,sampleRate,!0),t.setUint32(28,4*sampleRate,!0),t.setUint16(32,4,!0),t.setUint16(34,16,!0),writeString(t,36,"data"),t.setUint32(40,2*e.length,!0),floatTo16BitPCM(t,44,e),new Blob([n],{type:"audio/wav"})}var chunksL=[],chunksR=[],sampleRate,recordings={};this.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"finishRecording":var n=finishRecording();sendMessage(e,{url:n});break;case"combineRecordings":var n=combineRecordings(e.data.recordings);sendMessage(e,{url:n});break;case"clearRecordings":clearAll()}};