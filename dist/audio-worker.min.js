function init(e){recordingSampleRate=e.sampleRate}function record(e){chunksL.push(e[0]),chunksR.push(e[1])}function clearRecordings(){for(var e in recordings){var n=recordings[e];"url"in n&&URL.revokeObjectURL(n.url)}recordings={}}function finishRecording(){var e=combineChunks(chunksL);chunksL=[];var n=combineChunks(chunksR);chunksR=[];var t=[e,n],a={numChannels:1,sampleSize:1,sampleRate:recordingSampleRate},r=encodeWav(t,a),s=URL.createObjectURL(r);return recordings[s]={wav:r,url:s,channels:t},s}function combineRecordings(e){for(var n=[],t=[],a=0;a<e.length;a+=1){var r=e[a];if(r in recordings){var s=recordings[r];n.push(s.channels[0]),t.push(s.channels[1])}}var i=combineChunks(n),o=combineChunks(t),c=[i,o],l={numChannels:1,sampleSize:1,sampleRate:recordingSampleRate},h=encodeWav(c,l);return{wav:h,encoding:l}}function averageSamples(e){var n=e[0],t=e[1];if(n.length!=t.length)throw"cannot average samples of different length";for(var a=n.length,r=new Float32Array(a),s=0,i=0;a>i;)r[s++]=(n[i]+t[i])/2,i++;return r}function interleaveSamples(e){var n=e[0],t=e[1];if(n.length!=t.length)throw"cannot interleave samples of different length";for(var a=n.length,r=new Float32Array(2*a),s=0,i=0;a>i;)r[s++]=n[i],r[s++]=t[i],i++;return r}function combineChunks(e){for(var n=0,t=0;t<e.length;t++)n+=e[t].length;var a=new Float32Array(n),r=0;for(t=0;t<e.length;t++)a.set(e[t],r),r+=e[t].length;return a}function sendMessage(e,n){this.postMessage({callbackId:e.data.callbackId,result:n})}function floatTo16BitPCM(e,n,t){for(var a=0;a<t.length;a++,n+=2){var r=Math.max(-1,Math.min(1,t[a]));e.setInt16(n,0>r?32768*r:32767*r,!0)}}function floatTo8BitPCM(e,n,t){for(var a=0;a<t.length;a++,n+=1){var r=(Math.max(-1,Math.min(1,t[a]))+1)/2;e.setInt8(n,255*r,!0)}}function writeString(e,n,t){for(var a=0;a<t.length;a++)e.setUint8(n+a,t.charCodeAt(a))}function FIR(e){this.coeffs=e,this.nCoeffs=e.length,this.registers=new Float32Array(this.nCoeffs),this.iTopReg=this.nCoeffs-1}function downsample6x(e){return downsample(e,new FIR(FIR_48k_8k),6)}function downsample3x(e){return downsample(e,new FIR(FIR_48k_16k),3)}function downsample(e,n,t){for(var a=FIR_48k_8k.length,r=0,s=0;2*a>s;s++)n.sampleIn(e[r++]);for(var i=0,o=new Float32Array(e.length/t),c=0;r<e.length;)0===c&&(o[i++]=n.sampleOut()),++c==t&&(c=0),n.sampleIn(e[r++]);for(;i<o.length;)o[i++]=n.sampleOut(),n.sampleIn(0);return o}function encodeWav(e,n){var t=2==n.numChannels?interleaveSamples(e):averageSamples(e);48e3==recordingSampleRate&&(t=downsample6x(t),n.sampleRate=8e3,n.sampleSize=2);var a=n.numChannels*n.sampleSize,r=t.length*a,s=new ArrayBuffer(44+r),i=new DataView(s);switch(writeString(i,0,"RIFF"),i.setUint32(4,s.byteLength-8,!0),writeString(i,8,"WAVE"),writeString(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,n.numChannels,!0),i.setUint32(24,n.sampleRate,!0),i.setUint32(28,n.sampleRate*a,!0),i.setUint16(32,a,!0),i.setUint16(34,8*n.sampleSize,!0),writeString(i,36,"data"),i.setUint32(40,r,!0),n.sampleSize){case 1:floatTo8BitPCM(i,44,t);break;case 2:floatTo16BitPCM(i,44,t)}return new Blob([s],{type:"audio/wav"})}var chunksL=[],chunksR=[],recordingSampleRate,recordings={};this.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"finishRecording":var n=finishRecording();sendMessage(e,{url:n});break;case"combineRecordings":var t=combineRecordings(e.data.recordings);sendMessage(e,t);break;case"getRecording":var a=recordings[e.data.recording];sendMessage(e,a&&a.wav);break;case"clearRecordings":clearRecordings(),sendMessage(e,{})}},FIR.prototype.sampleIn=function(e){var n=this.iTopReg;n+=1,n>=this.nCoeffs&&(n=0),this.registers[n]=e,this.iTopReg=n},FIR.prototype.sampleOut=function(){for(var e=0,n=0,t=this.iTopReg;t>=0;t--)e+=this.coeffs[n++]*this.registers[t];for(t=this.nCoeffs-1;t>this.iTopReg;t--)e+=this.coeffs[n++]*this.registers[t];return e};var FIR_48k_8k=[.028593547515597933,.03670747252586807,-.003425102001388845,-.05953402135953233,-.060917024563134026,.03697894250548,.19858060022396978,.32301558515313944,.32301558515313944,.19858060022396978,.03697894250548,-.060917024563134026,-.05953402135953233,-.003425102001388845,.03670747252586807,.028593547515597933],FIR_48k_16k=[.025988926951079665,-.013257585857849584,-.01828825082150171,.04308749505022258,-.03213590725580088,-.02054974978239911,.08284966957828693,-.09349946285437129,-.02176391714488415,.5475687821372176,.5475687821372176,-.02176391714488415,-.09349946285437129,.08284966957828693,-.02054974978239911,-.03213590725580088,.04308749505022258,-.01828825082150171,-.013257585857849584,.025988926951079665];